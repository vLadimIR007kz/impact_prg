<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2GIS Navi API</title>
    <meta name="description" content="Navi API directions example" />
    <style>
        html, body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid #007bff;
        }
        .site-name {
            font-size: 24px;
            font-weight: bold;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .button:hover {
            background-color: #0056b3;
            transform: scale(1.1);
            transition: all .2s ease-in-out;
        }
        .button:active {
            transform: scale(1.05);
            transition: all .2s ease-in-out;
        }

        .content {
            display: flex;
            padding: 20px;
            flex-grow: 1;
        }
        .testimonials {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .testimonial {
            display: flex;
            align-items: center;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 2px solid #007bff;
        }
        .testimonial img {
            border-radius: 50%;
            margin-right: 20px;
        }
        .testimonial-text {
            font-size: 16px;
            color: #333;
        }
        .map-container {
            flex-shrink: 0;
            margin-left: 20px;
            position: relative; 
        }
        #container {
            width: 1000px; 
            height: 450px; 
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        .sidebar {
            position: absolute;
            top: 0;
            right: -300px; 
            width: 300px;
            height: 100%;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: right 0.3s ease;
            border-left: 2px solid #007bff;
        }
        .sidebar.open {
            right: 0;
        }
        .sidebar h2 {
            margin-top: 0;
        }
        .sidebar button {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="site-name">Oz Jolyn</div>
        <div>
            <button class="button">placeholder</button>
            <button class="button">placeholder</button>
            <button class="button">placeholder</button>
            <button class="button">About us</button>
        </div>
    </div>
    <div class="content">
        <div class="testimonials">
            <div class="testimonial">
                <img src="https://via.placeholder.com/50" alt="Avatar">
                <div class="testimonial-text">
                   placeholder
                </div>
            </div>
            <div class="testimonial">
                <img src="https://via.placeholder.com/50" alt="Avatar">
                <div class="testimonial-text">
                    placeholder                 
                </div>
            </div>
            <div class="testimonial">
                <img src="https://via.placeholder.com/50" alt="Avatar">
                <div class="testimonial-text">
                    placeholder                 
                </div>
            </div>
            <div class="testimonial">
                <img src="https://via.placeholder.com/50" alt="Avatar">
                <div class="testimonial-text">
                    placeholder                 
                </div>
            </div>
        </div>
        <div class="map-container">
            <div id="container"></div>
            <div class="sidebar" id="sidebar">
                <h2>Information</h2>
                <p id="sidebar-content"></p>
                <button class="button" id="close-sidebar">Close</button>
            </div>
        </div>
    </div>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://unpkg.com/@2gis/mapgl-directions@^2/dist/directions.js"></script>
    <script>
        const map = new mapgl.Map('container', {
            center: [76.889709, 43.238949],
            zoom: 13,
            key: '297a0b42-6f4d-4f79-aeaa-117e64c166b1',
        });

        const directions = new mapgl.Directions(map, {
            directionsApiKey: '0cfd5100-db6b-4828-9c5e-bcbbd5d2a725',
        });

        const markers = [];
        let firstPoint;
        let secondPoint;
        let routeCoordinates = [];
        let selecting = 'a';
        const buttonText = ['Choose two points on the map', 'Reset points'];

        const controlsHtml = `<button id="reset" disabled>${buttonText[0]}</button>`;
        new mapgl.Control(map, controlsHtml, {
            position: 'topLeft',
        });
        const resetButton = document.getElementById('reset');

        resetButton.addEventListener('click', function() {
            selecting = 'a';
            firstPoint = undefined;
            secondPoint = undefined;
            routeCoordinates = [];
            directions.clear();
            this.disabled = true;
            this.textContent = buttonText[0];
        });

        const sidebar = document.getElementById('sidebar');
        const sidebarContent = document.getElementById('sidebar-content');
        const closeSidebarButton = document.getElementById('close-sidebar');

        closeSidebarButton.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        map.on('click', (e) => {
            const coords = e.lngLat;

            if (selecting != 'end') {
                markers.push(
                    new mapgl.Marker(map, {
                        coordinates: coords,
                        icon: 'https://docs.2gis.com/img/dotMarker.svg',
                    })
                );
            }

            if (selecting === 'a') {
                firstPoint = coords;
                selecting = 'b';
            } else if (selecting === 'b') {
                secondPoint = coords;
                selecting = 'end';
            }

            if (firstPoint && secondPoint) {
                directions.pedestrianRoute({
                    points: [firstPoint, secondPoint],
                }).then(result => {
                    if (result && result.routes && result.routes.length > 0 && result.routes[0].geometry) {
                        routeCoordinates = result.routes[0].geometry;
                        checkPointsOnRoute();
                    } else {
                        console.error('No route found');
                    }
                }).catch(error => {
                    console.error('Error generating route:', error);
                });
                markers.forEach((m) => m.destroy());
                resetButton.disabled = false;
                resetButton.textContent = buttonText[1];
            }
        });

        fetch('http://localhost:80/impact_prg/2gis/map.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                data.features.forEach(feature => {
                    const coord = feature.geometry.coordinates;
                    const properties = feature.properties;
                    const marker = new mapgl.Marker(map, {
                        coordinates: coord,
                        icon: 'https://docs.2gis.com/img/dotMarker.svg',
                    });

                    marker.on('click', () => {
                        const latitude = coord[1];
                        const longitude = coord[0];
                        sidebarContent.innerHTML = `<strong>Street:</strong> ${properties.name}<br><strong>Coordinates:</strong> [${latitude}, ${longitude}]`;
                        sidebar.classList.add('open');
                    });

                    markers.push(marker);
                });
            })
            .catch(error => {
                console.error('Error loading GeoJSON data:', error);
            });

        function checkPointsOnRoute() {
            fetch('http://localhost:80/impact_prg/2gis/map.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    data.features.forEach(feature => {
                        const point = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                        if (isPointOnRoute(point, routeCoordinates, 0.01)) { 
                            console.log('Point on route:', feature.properties.name);
                           
                        }
                    });
                })
                .catch(error => {
                    console.error('Error checking points on route:', error);
                });
        }

        function isPointOnRoute(point, route, threshold) {
            for (let i = 0; i < route.length - 1; i++) {
                const segmentStart = route[i];
                const segmentEnd = route[i + 1];
                if (distanceToSegment(point, segmentStart, segmentEnd) < threshold) {
                    return true;
                }
            }
            return false;
        }

        function haversineDistance([lat1, lon1], [lat2, lon2]) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lat2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function distanceToSegment(point, segmentStart, segmentEnd) {
            const [x0, y0] = point;
            const [x1, y1] = segmentStart;
            const [x2, y2] = segmentEnd;
            const A = x0 - x1;
            const B = y0 - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            const param = len_sq !== 0 ? dot / len_sq : -1;
            let xx, yy;
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            return haversineDistance([x0, y0], [xx, yy]);
        }
    </script>
</body>
</html>
